{
  "MetaData": {
    "Schema": {
      "ManagerName": "ProcessSchemaManager",
      "UId": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
      "A2": "ICLSendNotificationCaseProcess",
      "A5": "91278a55-4e9c-422a-9676-68b333a7b340",
      "B1": [],
      "B2": [],
      "B3": [
        {
          "UId": "66d4b585-c6cf-4eb7-a007-f42f503127ba",
          "A2": "System.Linq",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "91278a55-4e9c-422a-9676-68b333a7b340",
          "GF1": "null"
        }
      ],
      "B6": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
      "B8": "7.14.0.597",
      "FJ1": [],
      "IJ1": true,
      "BK8": "bb4d6607-026b-4b27-b640-8f5c77c1e89d",
      "IJ10": true,
      "BK15": [],
      "BK37": {
        "BL1": "Terrasoft.Core.Process.ProcessSchemaParameter",
        "UId": "cdd58be7-2dba-4a5e-869b-1ad5d6d7513a",
        "A2": "NotificationCaption",
        "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
        "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
        "L1": "8b3f29bb-ea14-4ce5-a5c5-293a929b6ba2",
        "L8": {
          "GS1": 3,
          "GS2": "[#[PropertyValue:Caption]#]"
        }
      },
      "BK1": "FFFFFFFF",
      "BK2": "FFBBBBBB",
      "BK3": [
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaLaneSet",
          "UId": "247a1175-7959-4022-8283-e8cd762f4fac",
          "A2": "LaneSet1",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "BL7": "11a47caf-a0d5-41fa-a274-a0b11f77447a",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "BM1": 0,
          "BM4": [
            {
              "BL1": "Terrasoft.Core.Process.ProcessSchemaLane",
              "UId": "09090b95-547f-40eb-836c-fccd3f73a47f",
              "A2": "Lane1",
              "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
              "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
              "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
              "IL2": "247a1175-7959-4022-8283-e8cd762f4fac",
              "BL7": "abcd74b9-5912-414b-82ac-f1aa4dcd554e",
              "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
              "CD1": [],
              "CD2": [],
              "CD4": "247a1175-7959-4022-8283-e8cd762f4fac",
              "CD7": []
            }
          ]
        }
      ],
      "BK5": [],
      "BK4": [
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaStartEvent",
          "UId": "c55f0683-a379-4efb-b0cf-e6c56276bfa4",
          "A2": "StartEvent1",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "IL2": "09090b95-547f-40eb-836c-fccd3f73a47f",
          "BL3": "50;184",
          "BL7": "53818048-7868-48f6-ada0-0ebaa65af628",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "BN2": "27;27",
          "BO3": true,
          "FC1": [],
          "ED1": false
        },
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaTerminateEvent",
          "UId": "cac443a6-f778-4264-89a6-2d5d34948f35",
          "A2": "TerminateEvent1",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "IL2": "09090b95-547f-40eb-836c-fccd3f73a47f",
          "BL3": "600;184",
          "BL7": "1bd93619-0574-454e-bb4e-cf53b9eb9470",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "BN2": "27;27",
          "BO3": true,
          "FC1": []
        },
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaScriptTask",
          "UId": "8dab660f-a981-466d-8818-e5676f2a50ab",
          "A2": "ScriptTask1",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "IL2": "09090b95-547f-40eb-836c-fccd3f73a47f",
          "BL3": "246;170",
          "BL7": "0e490dda-e140-4441-b600-6f5c64d024df",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "BN2": "69;55",
          "BO3": true,
          "BP2": [],
          "CL2": "FFFFFFFF",
          "CH1": "var UserConnection = context.UserConnection;\r\n            var arrIds = string.Empty;\r\n            List<ICLStoredOutputValue> similarRecords = new List<ICLStoredOutputValue>();\r\n            var storedProcedure = new StoredProcedure(UserConnection, \"iclFindAndUpdateNotifyCaseForTempStatus\");\r\n            using (var executor = UserConnection.EnsureDBConnection())\r\n            {\r\n                using (var reader = storedProcedure.ExecuteReader(executor))\r\n                {\r\n                    while (reader.Read())\r\n                    {\r\n                        Guid id = reader.GetColumnValue<Guid>(\"Id\");\r\n                        Guid idCase = reader.GetColumnValue<Guid>(\"ICLCaseId\");\r\n                        int longTerm = reader.GetColumnValue<int>(\"ICLOverTimeSolution\");\r\n                        var objectICLStoredOutputValue = new ICLStoredOutputValue();\r\n                        objectICLStoredOutputValue.Id = id;\r\n                        objectICLStoredOutputValue.IdCase = idCase;\r\n                        objectICLStoredOutputValue.TimeLong = longTerm;\r\n                        similarRecords.Add(objectICLStoredOutputValue);\r\n                    }\r\n                }\r\n                executor.CommitTransaction();\r\n            }\r\n            //отправка emails\r\n            var manager = this.UserConnection.ProcessSchemaManager;\r\n            var schema = manager.GetInstanceByName(@\"ICLCaseNotify\");\r\n            bool canUseFlowEngine = ProcessSchemaManager.GetCanUseFlowEngine(UserConnection, schema);\r\n            foreach (var record in similarRecords)\r\n            {\r\n                TimeSpan span = TimeSpan.FromMinutes(record.TimeLong);\r\n                string label = span.ToString(@\"hh\\:mm\\:ss\");\r\n\r\n                if (canUseFlowEngine)\r\n                {\r\n                    var flowEngine = new FlowEngine(UserConnection);\r\n                    var param = new Dictionary<string, object>();\r\n                    param[\"CaseIdParameter\"] = record.IdCase;\r\n                    param[\"TimeToParameter\"] = label;\r\n                    flowEngine.RunProcess(schema, param);\r\n                }\r\n                else\r\n                {\r\n                    Process process = schema.CreateProcess(UserConnection);\r\n                    process.SetPropertyValue(\"CaseIdParameter\", record.IdCase);\r\n                    process.SetPropertyValue(\"TimeToParameter\", label);\r\n                    process.Execute(this.UserConnection);\r\n                }\r\n            }\r\n            if (similarRecords.Count() > 0)\r\n            {\r\n                IEnumerable<Guid> idreminder = similarRecords.Select(en => en.Id);\r\n                //статус завершена\r\n                var updHistory = new Update(UserConnection, \"ICLCaseReminder\")\r\n                       .Set(\"ICLStatusId\", Column.Parameter(new Guid(\"E44A3710-2528-4B59-9733-17A77BA70B6D\")))\r\n                   .Where(\"Id\").In(Column.Parameters(idreminder));\r\n                updHistory.Execute();\r\n            }\r\n            return true;",
          "CH2": true
        },
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaSequenceFlow",
          "UId": "28b77bac-b42f-4717-97ec-2323ddd68b4d",
          "A2": "SequenceFlow1",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "BL7": "0d8351f6-c2f4-4737-bdd9-6fbfe0837fec",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "CI1": "c55f0683-a379-4efb-b0cf-e6c56276bfa4",
          "CI2": "8dab660f-a981-466d-8818-e5676f2a50ab",
          "CI3": "null",
          "CI5": "FF939598",
          "CI6": 1,
          "CI8": "-1;0"
        },
        {
          "BL1": "Terrasoft.Core.Process.ProcessSchemaSequenceFlow",
          "UId": "183599a9-b5da-4b7f-893b-793db5e740c4",
          "A2": "SequenceFlow2",
          "A3": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A4": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "A5": "22fc7faa-2155-4f76-8258-0108fc7d3d22",
          "BL7": "0d8351f6-c2f4-4737-bdd9-6fbfe0837fec",
          "BL8": "3074b30e-1cc5-427c-a080-3c1a8b499dc7",
          "CI1": "8dab660f-a981-466d-8818-e5676f2a50ab",
          "CI2": "cac443a6-f778-4264-89a6-2d5d34948f35",
          "CI3": "null",
          "CI5": "FF939598",
          "CI6": 1,
          "CI7": "1;0"
        }
      ],
      "BK9": [],
      "BK18": "Business Process",
      "BK29": true,
      "BK30": true,
      "BK32": "public class ICLStoredOutputValue\r\n        {\r\n            public Guid Id { get; set; }\r\n            public int TimeLong { get; set; }\r\n            public Guid IdCase { get; set; }\r\n        }",
      "BK34": "null",
      "BK24": []
    }
  }
}